name: nomecliente-infra

# ─────────────────────────────────────────────────────────────────────────────
# Local development infrastructure
#
# Services & exposed ports
#   PostgreSQL 17    → localhost:5432
#   Keycloak 26.x    → http://localhost:8180   (direct, for Spring Boot)
#                      https://localhost:8443   (via nginx, for browser/Postman)
#   WireMock         → http://localhost:9090   (direct)
#                      https://localhost:9091   (via nginx)
#   Mailpit SMTP     → localhost:1025
#   Mailpit Web UI   → http://localhost:8025   (direct)
#                      https://localhost:8026   (via nginx)
#   nginx hub        → http://localhost:80     (service index)
#
# Startup (first time and every subsequent time):
#   cd infra && docker compose up -d
#
# Reset (deletes all data and regenerates certs):
#   docker compose down -v && docker compose up -d
# ─────────────────────────────────────────────────────────────────────────────

services:

  # ── TLS certificate generator (one-shot) ──────────────────────────────────
  # Runs alpine+openssl, generates a self-signed cert with correct SANs into
  # the `certs_data` named volume, then exits. Idempotent: skips if cert
  # already exists. nginx depends on this service completing successfully.
  certs:
    image: alpine
    container_name: infra_certs
    volumes:
      - certs_data:/certs
      - ./scripts/openssl.cnf:/tmp/openssl.cnf:ro
    command:
      - sh
      - -c
      - |
        if [ -f /certs/localhost.crt ]; then
          echo "TLS certificate already present — skipping generation."
          exit 0
        fi
        apk add --no-cache openssl > /dev/null 2>&1
        openssl req -x509 \
          -newkey rsa:4096 \
          -keyout /certs/localhost.key \
          -out    /certs/localhost.crt \
          -days   3650 \
          -nodes  \
          -config /tmp/openssl.cnf
        chmod 600 /certs/localhost.key
        echo "TLS certificate generated (valid 10 years)."
    restart: "no"
    networks:
      - infra_net

  # ── PostgreSQL 17 ──────────────────────────────────────────────────────────
  postgres:
    image: postgres:17
    container_name: infra_postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_ROOT_PASSWORD:-postgres}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 15
    networks:
      - infra_net

  # ── Keycloak 26.x ──────────────────────────────────────────────────────────
  keycloak:
    image: quay.io/keycloak/keycloak:${KEYCLOAK_VERSION:-26.1.4}
    container_name: infra_keycloak
    # start-dev: relaxed production checks; --import-realm on first run only
    command: start-dev --import-realm
    environment:
      # Database backend
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/${KEYCLOAK_DB_NAME:-keycloak_db}
      KC_DB_USERNAME: ${KEYCLOAK_DB_USER:-keycloak_user}
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak_pass}
      # Hostname — must match the issuer in Spring Boot's application.yml
      KC_HOSTNAME: localhost
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_PORT: 8180
      KC_HTTP_ENABLED: "true"
      # Trust X-Forwarded-* headers sent by nginx
      KC_PROXY_HEADERS: xforwarded
      # Admin console credentials
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_LOG_LEVEL: INFO
    volumes:
      - ./keycloak/realm-import.json:/opt/keycloak/data/import/realm-import.json:ro
    ports:
      - "8180:8180"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - infra_net

  # ── WireMock ───────────────────────────────────────────────────────────────
  wiremock:
    image: wiremock/wiremock:${WIREMOCK_VERSION:-latest}
    container_name: infra_wiremock
    command: --verbose --global-response-templating
    volumes:
      - ./wiremock/mappings:/home/wiremock/mappings:ro
      - ./wiremock/__files:/home/wiremock/__files:ro
    ports:
      - "9090:8080"
    networks:
      - infra_net

  # ── Mailpit (mock SMTP + web UI) ───────────────────────────────────────────
  mailpit:
    image: axllent/mailpit:${MAILPIT_VERSION:-latest}
    container_name: infra_mailpit
    environment:
      MP_SMTP_AUTH_ALLOW_INSECURE: "true"
      MP_MAX_MESSAGES: "500"
      MP_UI_BIND_ADDR: "0.0.0.0:8025"
      MP_SMTP_BIND_ADDR: "0.0.0.0:1025"
    ports:
      - "1025:1025"   # SMTP
      - "8025:8025"   # Web UI
    networks:
      - infra_net

  # ── nginx (HTTPS termination + service hub) ────────────────────────────────
  nginx:
    image: nginx:alpine
    container_name: infra_nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/html:/usr/share/nginx/html:ro
      - certs_data:/etc/nginx/certs:ro       # generated by the `certs` service
    ports:
      - "80:80"       # HTTP hub / service index
      - "8443:8443"   # Keycloak HTTPS
      - "9091:9091"   # WireMock HTTPS
      - "8026:8026"   # Mailpit HTTPS
    depends_on:
      certs:
        condition: service_completed_successfully
      keycloak:
        condition: service_started
      wiremock:
        condition: service_started
      mailpit:
        condition: service_started
    networks:
      - infra_net

# ─────────────────────────────────────────────────────────────────────────────
volumes:
  postgres_data:
  certs_data:       # TLS certificate generated by the `certs` service

networks:
  infra_net:
    driver: bridge

